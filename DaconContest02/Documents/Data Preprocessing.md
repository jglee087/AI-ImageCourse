# Data Preprocessing

**탐색적 데이터 분석(Exploratory Data Analysis, EDA)**라고 불리는 데이터 전처리 단계에서 수행해야 할 일들에 대해 순서대로 정리해 보자.  데이터 전처리는 대체로 1. 데이터 셋 확인 2. 결측값 처리 3. 이상값 처리 4. Feature Engineering 의 순서로 진행된다.



### 1. 데이터 셋 확인

- 변수 확인

1. 각 변수의 유형

    범주형인지 연속형인지 확인

2. 변수의 데이터 타입 확인: Date, character, Numeric 여부 확인



- Raw 데이터 확인

1. 단변수 분석

   변수 하나에 대해 기술 통계를 확인하는 단계이다. Historgram이나 boxplot을 사용하여 평균, 최빈, 중간, 최대, 최소 값 등과 함께 각 변수들의 분포를 확인한다.

2. 이변수 분석

   변수 2개 간의 관계를 분석하는 것이다. 변수의 유형에 따라 적절한 시각화 및 분석 방법을 사용한다.

   |                 | 그래프                                | 분석 방법                                                    |
   | --------------- | ------------------------------------- | ------------------------------------------------------------ |
   | 연속형과 연속형 | Scatter plot                          | Corrleation 분석                                             |
   | 범주형과 범주형 | 누적막대그래프                        | Chi-square 분석                                              |
   | 연속형과 범주형 | 누적막대그래프<br />범주 별 Histogram | 범주의 종류에 따라서<br />2개: T-test/Z-test<br />3개 이상: ANOVA |



3. 셋 이상의 변수

   세개 이상의 변수 간의 관계를 분석할 범주형 변수가 하나이상 포함되어 있는 경우 변수를 범주에 따라 쪼갠 후에 위의 분석 방법을 사용한다.



### 2.  결측값 처리(Missing Value Treatment)

결측값이 있는 상태로 모델을 만들면 변수간의 관계가 왜곡되기 때문에 모델의 정확성이 낮아진다. 결측값이 발생하는 여러가지 유형이 있다. 결측값이 무작위로 발생하느냐, 아니면 결측값의 발생이 다른 변수와 관계가 있는지 여부에 따라 결측값을 처리하는 방법도 조금씩 다르다.

- 삭제

  결측값이 발생한 모든 관측치를 삭제하거나 데이터 중 모델에 포함시킬 변수들 중 관측값이 발생한 모든 관측치를 삭제하는 방법이 있다.

  전체 삭제는 간편한 반면 관측치가 줄어들어 모델의 유효성이 낮아질 수 있고,  부분 삭제는 모델에 따라 변수가 제각각 다르기 때문에 관리 비용이 늘어난다는 단점이 있다.

  삭제는 결측값이 무작위로 발생한 경우에 사용한다. 결측값이 무작위로 발생한 것이 아닌데 관측치를 삭제한 데이터를 사용할 경우 왜곡된 모델이 생성될 수 있다.

- 다른 값으로 대체 (평균, 최빈값, 중간값)

  결측값이 발생한 경우 다른 관측치의 평균, 최빈값, 중간값 등으로 대체할 수 있다. 모든 관측치의 평균값 등으로 대체하는 일괄 대체 방법과, 범주형 변수를 활용해 유사한 유형의 평균값 등으로 대체하는 유사 유형 대체 방법이 있다.

  결측 값의 발생이 다른 변수와 관계가 있는 경우 대체 방법이 유용한 측면은 있으나 유사 유형 대체 방법의 경우 어떤 범주형 변수를 유사한 유형으로 선택할 것인지는 자의적으로 선택하므로 모델이 왜곡될 가능성이 존재한다.

- 예측값 삽입

  결측값이 없는 관측치를 트레이닝 데이터로 사용해서 결측값을 예측하는 모델을 만들고 이 모델을 통해 결측값이 있는 관측 데이터의 결측값을 예측하는 방법이다. 주로 회귀나 로지스틱 회귀를 사용합니다. 

  대체하는 방법보다 조금 덜 자의적이긴 하나 결측 값이 다양한 변수에서 발생하는 경우 사용 가능 변수 수가 적어 적합한 모델을 만들기 어렵고, 또 이렇게 만들어 진 모델의 예측력이 낮은 경우에는 사용하기 어려운 방법이다.

  

### 3. 이상값 처리

**이상값**이란 데이터/샘플과 동떨어진 관측치로, 모델을 왜곡할 가능성이 있는 관측치를 의미한다.



#### 이상값 찾아내기

이상값을 찾아 내기 위한 쉽고 간단한 방법은 변수의 분포를 시각화하면 된다. 일반적으로 하나의 변수에 대해서는 boxplot이나 histogram을, 두 개의 변수 간 이상값을 찾기 위해서는 scatter plot을 사용합니다. 시각적으로 확인하는 방법은 직관적이지만 자의적이기도 하고 하나하나 확인해야 해서 번거로운 측면이 있지만 반드시 필요하다.

두 변수 간 이상값을 찾기 위한 또 다른 방법으로는 두 변수 간 회귀 모형에서 Residual, Studentized residual(혹은 standardized residual), leverage, Cook’s D값을 확인하면 된다.



#### 이상값 처리하기

- 단순 삭제

  이상값이 사람 실수에 의해서 발생한 경우에는 해당 관측치를 삭제하면 된다. 단순 오타나, 주관식 설문 등의 비현실적인 응답, 데이터 처리 과정에서의 오류 등의 경우에 사용한다.

- 다른 값으로 대체

  절대적인 관측치의 숫자가 작은 경우,  삭제의 방법으로 이상치를 제거하면 관측치의 절대량이 작아지는 문제가 발생한다. 이런 경우 이상 값이 사람 실수에 의해 발생했더라도 관측치를 삭제하는 대신 다른 값(평균 등)으로 대체하거나, 결측값과 유사하게 다른 변수들을 사용해서 예측 모델을 만들고, 이상값을 예측한 후 해당 값으로 대체하는 방법도 사용할 수 있다.

- 이상치 제거

  일반적으로 표준화를 한 후 표준편차가 -3 이하 및 +3 보다 큰 것을 제거하는 방식이 있다.  IQR 방식을 사용하여 75% percentile * 1.5 이상이거나 25 percentile* 1.5 이하인 경우 극단치로 처리하는 방식이다. 또는  도메인 지식을 이용하거나 binning 처리하는 방식이 이용된다. 

- 변수화

  이상값이 자연 발생한 경우, 단순 삭제나 대체의 방법을 통해 수립된 모델은 설명/예측하고자 하는 현상을 잘 설명하지 못할 수도 있다.

- 리샘플링

  자연 발생한 이상값을 처리하는 또 다른 방법으로는 해당 이상값을 분리해서 모델을 만드는 방법이 있다. 대체적으로 경력에 따라 연봉이 상승하는 경향이 있다. 만약 경력이 많은데도 불구하고 연봉이 높지 않은 사람이 존재하기도 하는데 이러한 사람의 연봉은 이상값이 될 수 있다. 이 경우 간단하게 이상치를 삭제하고 분석 범위를 변경하여 데이터를 다룬다면 이상값을 처리할 수 있다.

- 케이스를 분리하여 분석

  위와 동일한 사례에서 실은 경력이 길더라도 연봉이 낮아지는 현상이 실제로 발생할 수도 있다. 이 경우 이상값을 대상에서 제외시키는 것은 현상에 대한 정확한 설명이 되지 않을 수 있다. 보다 좋은 방법은 이상값을 포함한 모델과 제외한 모델을 모두 만들고 각각의 모델에 대한 설명을 달아준다. 자연 발생한 이상값에 별다른 특이점이 발견되지 않는다면, 단순 제외 보다는 케이스를 분리하여 분석하는 방법도 존재한다.

  

### 4. Feature Engineering

Feature Engineering이란, 기존의 변수를 사용해서 데이터에 정보를 추가하는 일련의 과정이다. 새로 관측치나 변수를 추가하지 않고도 기존의 데이터를 보다 유용하게 만드는 방법론이다.

- Scailing

  변수의 단위를 변경하고 싶거나, 변수의 분포가 편향되어 있을 경우, 변수 간의 관계가 잘 드러나지 않는 경우에는 변수 변환의 방법을 사용한다. 가장 자주 사용하는 방법으로는 Log 함수가 있고, 유사하지만 좀 덜 자주 사용되는 Square root를 취하는 방법도 있다.

- Binning

  연속형 변수를 범주형 변수로 만드는 방법이 있다. 예를 들어 연봉 데이터가 수치로 존재하는 경우, 이를 x 미만, x~y, y~z 하는 식으로 범주형 변수로 변환한다. Binning에는 특별한 원칙이 있는 것이 아니기 때문에 창의적인 방법으로 binning이 가능하다.

-  Transform

  기존 존재하는 변수의 성질을 이용해 다른 변수를 만드는 방법이 있다. 예를 들어 날짜 별 판매 데이터가 있다면, 날짜 변수를 주중/주말로 나눈 변수를 추가한다던지, eSports의 관람객 데이터의 경우 해당 일에 SKT T1의 경기가 있는지 여부 등을 추가한다. Transform에도 특별한 원칙이 있는 것은 아니며, 분석 방법에 따라 다양한 변수가 생성될 수 있다.

- Dummy

  Binning과는 반대로 범주형 변수를 연속형 변수로 변환하기 위해 사용한다. 사용하고자 하는 분석 방법론에서 필요한 경우에 주로 사용한다.

- 변수가 많은 경우

  PCA 등으로 차원 축소하거나 변수 중요도 파악후 불필요 변수 제거한다.



<참고>

http://www.dodomira.com/2016/10/20/how_to_eda/